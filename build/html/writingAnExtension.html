<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Extension Authors &mdash; Runestone Interactive 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.0.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/pytutor.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/codemirror.css" type="text/css" />
    <link rel="stylesheet" href="_static/activecode.css" type="text/css" />
    <link rel="stylesheet" href="_static/parsons.css" type="text/css" />
    <link rel="stylesheet" href="_static/lib/prettify.css" type="text/css" />
    <link rel="stylesheet" href="_static/jquery-ui-1.10.3.custom.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/user-highlights.css" type="text/css" />
    <link rel="stylesheet" href="../runestone-custom-sphinx-bootstrap.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/d3.v2.min.js"></script>
    <script type="text/javascript" src="_static/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery.ba-bbq.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery.jsPlumb-1.3.10-all-min.js"></script>
    <script type="text/javascript" src="_static/js/pytutor.js"></script>
    <script type="text/javascript" src="_static/jquery.highlight.js"></script>
    <script type="text/javascript" src="_static/bookfuncs.js"></script>
    <script type="text/javascript" src="_static/codemirror.js"></script>
    <script type="text/javascript" src="_static/python.js"></script>
    <script type="text/javascript" src="_static/javascript.js"></script>
    <script type="text/javascript" src="_static/activecode.js"></script>
    <script type="text/javascript" src="_static/skulpt.min.js"></script>
    <script type="text/javascript" src="_static/skulpt-stdlib.js"></script>
    <script type="text/javascript" src="_static/assess.js"></script>
    <script type="text/javascript" src="_static/animationbase.js"></script>
    <script type="text/javascript" src="_static/lib/jquery.min.js"></script>
    <script type="text/javascript" src="_static/lib/jquery-ui.min.js"></script>
    <script type="text/javascript" src="_static/lib/prettify.js"></script>
    <script type="text/javascript" src="_static/lib/underscore-min.js"></script>
    <script type="text/javascript" src="_static/lib/lis.js"></script>
    <script type="text/javascript" src="_static/parsons.js"></script>
    <script type="text/javascript" src="_static/parsons-noconflict.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/jquery-ui-1.10.3.custom.min.js"></script>
    <script type="text/javascript" src="_static/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.0.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <script type="text/javascript" src="_static/waypoints.min.js"></script>
    <script type="text/javascript" src="_static/rangy-core.js"></script>
    <script type="text/javascript" src="_static/rangy-textrange.js"></script>
    <script type="text/javascript" src="_static/rangy-cssclassapplier.js"></script>
    <script type="text/javascript" src="_static/user-highlights.js"></script>
    <script type="text/javascript" src="_static/jquery.idle-timer.js"></script>
    <script type="text/javascript" src="_static/processing-1.4.1.min.js"></script>
    <script type="text/javascript" src="_static/jquery.hotkey.js"></script>
    <link rel="top" title="Runestone Interactive 1.0 documentation" href="index.html" />
    <link rel="next" title="Getting Help" href="gettinghelp.html" />
    <link rel="prev" title="Developer Documentation for Runestone Interactive Tools" href="developer.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
<script type="text/javascript">
  eBookConfig = {};
  eBookConfig.host = 'http://interactivepython.org' ? 'http://interactivepython.org' : 'http://127.0.0.1:8000';
  eBookConfig.app = eBookConfig.host+'/runestone';
  eBookConfig.ajaxURL = eBookConfig.app+'/ajax/';
  eBookConfig.course = 'docs';
  eBookConfig.logLevel = 10;
  eBookConfig.loginRequired = false
  eBookConfig.build_info = "";
  eBookConfig.isLoggedIn = false;
</script>

<div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&status=0";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>


<script>
var _prum = [['id', '521dfcc4abe53d0749000000'],
             ['mark', 'firstbyte', (new Date()).getTime()]];
(function() {
    var s = document.getElementsByTagName('script')[0]
      , p = document.createElement('script');
    p.async = 'async';
    p.src = '//rum-static.pingdom.net/prum.min.js';
    s.parentNode.insertBefore(p, s);
})();
</script>



  </head>
  <body>


<!-- Begin navbar -->
<div id="navbar" class="navbar navbar-default navbar-fixed-top" role="navigation">

  <div class="container">

    <div class="navbar-header">
      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
      <button type='button' class='navbar-toggle' data-toggle="collapse" data-target=".navbar-ex1-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div>
        <a class="brand-logo" style='background: transparent url("_static/img/logo_small.png") no-repeat 0px 0px;' href="/runestone/default/user/login">&nbsp; </a>
        <a class="navbar-brand" href="index.html">Runestone Interactive</a>
      </div>
    </div>

    <div class="navbar-collapse collapse navbar-ex1-collapse">

      <ul class="nav navbar-nav navbar-right">

        <li class="divider-vertical"></li>

        <!-- social media dropdown -->
        <li class="dropdown">
          <a class="dropdown-toggle" href="#" data-toggle="dropdown">
            <i class="glyphicon glyphicon-share-alt" style="opacity: 0.9"></i>
          </a>
          <ul class="dropdown-menu social-menu">
              <li>
                <div>
                  <b>Runestone in social media:</b>
                </div>
                <a href="https://twitter.com/iRunestone" class="twitter-follow-button" data-show-count="true">Follow @iRunestone</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                <div class="fb-like" data-href="https://www.facebook.com/RunestoneInteractive" data-send="false" data-layout="button_count" data-width="300" data-show-faces="false" data-font="arial"></div>
              </li>

              <li class="divider"></li>
              <li>
                <div>
                  <b>Help support us:</b>
                </div>
                <div class="gittip">
                  <iframe style="border:0;"
                    src="https://www.gittip.com/bnmnetp/widget.html"
                    width="48pt" height="22pt" class="gittip-button">
                  </iframe>
                </div>
                <div>
                    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
                  <input type="hidden" name="cmd" value="_s-xclick">
                  <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----
                  ">
                  <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
                  <img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
                  </form> 
                    
                </div>
              </li>
          </ul>
        </li>
        <!-- end social media dropdown -->

        <li class="divider-vertical"></li>

        <!-- search dropdown -->
        <li class="dropdown">
          <a class="dropdown-toggle" href="#" data-toggle="dropdown">
            <i class="glyphicon glyphicon-search" style='opacity:0.9;'></i>
          </a>
          <ul class='dropdown-menu'>
            
                <li><a href='index.html'>Table of Contents</a></li>
            
            <li><a href='/runestone/static/docs/genindex.html'>Book Index</a></li>
            <li class="divider"></li>
            <li id="scratch_ac_link"><a href="javascript:toggleScratchActivecode()">Scratch ActiveCode</a></li>
            <li class="divider"></li>
            <li style="width: 240px;">
              <form class="navbar-search" style="margin:10px;" action="search.html" method="get">
                <div class="input-group">
                  <input type="text" class="form-control" name="q" placeholder="Search this book" />
                  <span class="input-group-btn">
                    <button class="btn btn-primary" style="margin:0;" type="submit">
                      <i class="glyphicon glyphicon-search"></i>
                    </button>
                  </span>
                </div><!-- /input-group -->
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
            </li>
          </ul>
        </li>
        <!-- end search dropdown -->

        <li class="divider-vertical"></li>

        <!-- user account dropdown -->
        <li class="dropdown">
          <a class="dropdown-toggle" href="#" data-toggle="dropdown">
            <i class="glyphicon glyphicon-user" style="opacity:0.9;"></i>
          </a>
          <ul class="dropdown-menu user-menu">
            <li><span class='loggedinuser'></span></li>
            <li class="divider"></li>
            <li><a href='http://interactivepython.org/runestone/admin/index'>Instructor's Page</a></li>
            <li class="divider"></li>
            <li><a href="http://interactivepython.org/runestone/default/user/profile" id="profilelink">Edit Profile</a></li>
            <li><a href="http://interactivepython.org/runestone/default/user/change_password" id="passwordlink">Change Password</a></li>
            <li><a href="http://interactivepython.org/runestone/default/user/register" id="registerlink">Register</a></li>
            <li class='loginout'><a href='#'>Login</a></li> <!-- correct link populated by addNavbarLoginLink() -->
          </ul>
        </li>
        <!-- end user account dropdown -->

        <li class="divider-vertical"></li>

        <!-- help menu dropdown -->
        <li class="dropdown">
          <a class="dropdown-toggle" href="#" data-toggle="dropdown">
            <i class="glyphicon glyphicon-question-sign" style="opacity:0.9;"></i>
          </a>
          <ul class="dropdown-menu user-menu">
            <li><a href='/runestone/static/docs/navhelp.html'>Navigation Help</a></li>
            <li><a href='/runestone/static/overview/instructor.html'>Help for Instructors</a></li>            
            <li class="divider"></li>
            <li><a href='http://runestoneinteractive.org'>About Runestone</a></li>
            <li><a href='https://github.com/bnmnetp/runestone/issues/new'>Report A Problem</a></li>
          </ul>
        </li>
        <!-- end help menu dropdown -->

        <li class="divider-vertical"></li>

      </ul>

      <ul class="nav navbar-nav">
        <li class="divider-vertical"></li>
        
          <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"><ul>
<li><a class="reference internal" href="#">Extension Authors</a><ul>
<li><a class="reference internal" href="#components-of-a-directive">Components of a directive</a></li>
<li><a class="reference internal" href="#initialization">Initialization</a></li>
<li><a class="reference internal" href="#parsing">Parsing</a></li>
<li><a class="reference internal" href="#output">Output</a></li>
</ul>
</li>
</ul>
</ul>
</li>
          <li class="divider-vertical"></li>
        
        
          
  <li id="relations-prev" title="Previous Chapter - Developer Documentation for Runestone Interactive Tools" data-toggle="tooltip">
    <a href="developer.html" >
      <i class='glyphicon glyphicon-backward' style='opacity:0.9;'></i>
    </a>
  </li>
  
  <li id="relations-next" title='Next Chapter - Getting Help' data-toggle="tooltip" >
    <a href="gettinghelp.html" >
      <i class='glyphicon glyphicon-forward' style='opacity:0.9;'></i>
    </a>
  </li>
  <li class="divider-vertical"></li>

<script type="text/javascript">
  opts = {'placement':'bottom',
          'selector': '',
          'delay': { show: 100, hide: 50}
         };

  $('#relations-prev').tooltip(opts);
  $('#relations-next').tooltip(opts);
</script>
        
        
          <li>
  <a href="_sources/writingAnExtension.txt"
     rel="nofollow">Source</a></li>
        
      </ul>

    </div>
  </div>
</div>


<div class="container">
  
  <div class="section" id="extension-authors">
<h1>Extension Authors<a class="headerlink" href="#extension-authors" title="Permalink to this headline">¶</a></h1>
<p>In this section I will take you through an example of writing a new directive for the runestone interactive system.  In this case we will look at adding a <tt class="docutils literal"><span class="pre">datafile</span></tt> directive.</p>
<p>The <tt class="docutils literal"><span class="pre">datafile</span></tt> directive is going to be used in conjunction with the skulpt file operations.  For skulpt to read a file we must provide some data that data can either be data that is part of a <tt class="docutils literal"><span class="pre">&lt;pre&gt;</span></tt> element or if we want the data to be editable we can embed the data in a <tt class="docutils literal"><span class="pre">&lt;textarea&gt;</span></tt> element.   In the case of the <tt class="docutils literal"><span class="pre">&lt;pre&gt;</span></tt> element the data might be visible or it might be hidden.  Our directive will look something like this:</p>
<p>Indentation is important.  Following the directive line, you can have as many optional parameters as you want.  Followed by a blank line, followed by the main body of your directive.</p>
<div class="highlight-python"><div class="highlight"><pre>.. datafile::  myid
   :edit:
   :rows: 20
   :cols: 65

   line 1  some data
   line 2  some more data
   line 3  this is the end
</pre></div>
</div>
<p>So the datafile takes one required parameter, a unique id that is used by the Skulpt <tt class="docutils literal"><span class="pre">open</span></tt> function as the file name.  The <tt class="docutils literal"><span class="pre">:edit:</span></tt> parameter tells us to make a textarea rather than a pre.  The <tt class="docutils literal"><span class="pre">:rows:</span></tt> and <tt class="docutils literal"><span class="pre">:cols:</span></tt> tell us how many rows and columns to add to the textarea.  If these are not present, then our directive should do its best to figure out a reasonable number of rows and columns.</p>
<p>The html output of the directive above should be:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;textarea id=&quot;myid&quot; cols=&quot;65&quot; rows=&quot;20&quot;&gt;
line 1  some data
line 2  some more data
line 3  this is the end
&lt;/textarea&gt;
</pre></div>
</div>
<p>We will also make this extension work if the user wants to generate a non-interactive paper or pdf version of some text using LaTeX.  In this case the output of our directive should simply be:</p>
<div class="highlight-python"><div class="highlight"><pre>\begin{verbatim}
line 1  some data
line 2  some more data
line 3  this is the end
\end{verbatim}
</pre></div>
</div>
<p>Unless the <tt class="docutils literal"><span class="pre">:hide:</span></tt> flag is present in which case we won&#8217;t generate anything.</p>
<div class="section" id="components-of-a-directive">
<h2>Components of a directive<a class="headerlink" href="#components-of-a-directive" title="Permalink to this headline">¶</a></h2>
<p>There are several parts to writing an extension.</p>
<ol class="arabic simple">
<li>Initialization:  In this part you need to let sphinx know that there there is a new directive.  The name of the directive is associated with a Python class that derives from the restructuredText <tt class="docutils literal"><span class="pre">Directive</span></tt> class.</li>
<li>Parse Time:  In this stage of processing sphinx is building the document object model.  A tree of nodes.  At this stage we process all of the arguments and gather the main content into a structure that can be used later when rendering a document in whatever format:  html, latex, epub, etc.</li>
<li>Output:  At this stage we take the data that we have and format it for output by whatever <em>writer</em> is being used, again html, latex, etc.</li>
</ol>
<p>All of the components of a directive can go in a single Python file.  Sphinx sees these extensions as simple python packages, so you can create a folder with an <tt class="docutils literal"><span class="pre">__init.py</span></tt> file or you can create an <tt class="docutils literal"><span class="pre">__init__.py</span></tt> file that imports one or more of your own files.</p>
<p>The <tt class="docutils literal"><span class="pre">__init__.py</span></tt> file should go in the modules folder following the folder heirarchy that is in place.  For example  <tt class="docutils literal"><span class="pre">luther/sphinx/datafile/</span></tt>.</p>
</div>
<div class="section" id="initialization">
<h2>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h2>
<p>For the initialization phase we need to provide a setup function.  The setup function connects the directive name with a class, and tells skulpt about any css or javscript files that will be needed to support any html output.</p>
<p>The initialization code for the datafile directive looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">directives</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">Directive</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s">&#39;datafile&#39;</span><span class="p">,</span><span class="n">DataFile</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_javascript</span><span class="p">(</span><span class="s">&#39;bookfuncs.js&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_javascript</span><span class="p">(</span><span class="s">&#39;skulpt/dist/skulpt.js&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_javascript</span><span class="p">(</span><span class="s">&#39;skulpt/dist/builtin.js&#39;</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">DataFileNode</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="p">(</span><span class="n">visit_df_node</span><span class="p">,</span> <span class="n">depart_df_node</span><span class="p">))</span>

    <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;doctree-resolved&#39;</span><span class="p">,</span><span class="n">process_datafile_nodes</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;env-purge-doc&#39;</span><span class="p">,</span> <span class="n">purge_datafiles</span><span class="p">)</span>
</pre></div>
</div>
<p>The key function here is the setup function.   The <tt class="docutils literal"><span class="pre">add_directive</span></tt> method maps the <tt class="docutils literal"><span class="pre">datafile</span></tt> directive to the <tt class="docutils literal"><span class="pre">DataFile</span></tt> class.  Then we add three javascript files we want to include along with a new node type called <tt class="docutils literal"><span class="pre">DataFileNode</span></tt>  This is the node that will get added to the document object model.</p>
<p>The next line connects the <tt class="docutils literal"><span class="pre">'doctree-resolved'</span></tt> event with a function called <tt class="docutils literal"><span class="pre">process_datafile_nodes</span></tt>.  This function could be used to create an index of our datafiles, or do nothing.  the <tt class="docutils literal"><span class="pre">env-purge-doc</span></tt> event is simliar but is called after all datafile nodes have been processed.</p>
</div>
<div class="section" id="parsing">
<h2>Parsing<a class="headerlink" href="#parsing" title="Permalink to this headline">¶</a></h2>
<p>During the parse phase there is one class for every directive.  This class must supply a run method that returns a list of nodes.  If you know that your directive is only ever going to create output for a particular rendering, e.g. html you can finish your run method by returning a <tt class="docutils literal"><span class="pre">raw</span></tt> node that is simply a string.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">return</span> <span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">mystring</span> <span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;html&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>In this case mystring could be as long and complicated an html string as you might like to make.  A minimal hello world type example might be:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">return</span> <span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;h1&gt;Hello World&lt;/h1&gt;&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;html&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>In other cases you will defer the rendering of the node until later, having built a structure that can support multiple output styles.  In our example you will see that we return:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">return</span> <span class="p">[</span><span class="n">DataFileNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)]</span>
</pre></div>
</div>
<p>Where the DataFileNode just maintains a dictionary of data items we will use when we want to render any of the possible output formats.</p>
<p>If you return a <tt class="docutils literal"><span class="pre">raw</span></tt> node then you can ignore the <tt class="docutils literal"><span class="pre">app.add_node(DataFileNode,</span> <span class="pre">html=(visit_df_node,</span> <span class="pre">depart_df_node))</span></tt> line in the <tt class="docutils literal"><span class="pre">setup</span></tt> method.</p>
<p>Here is the DataFile class along with its run method.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">DataFile</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>
    <span class="n">required_arguments</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">optional_arguments</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">has_content</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">option_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;hide&#39;</span><span class="p">:</span><span class="n">directives</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
        <span class="s">&#39;edit&#39;</span><span class="p">:</span><span class="n">directives</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
        <span class="s">&#39;rows&#39;</span><span class="p">:</span><span class="n">directives</span><span class="o">.</span><span class="n">positive_int</span><span class="p">,</span>
        <span class="s">&#39;cols&#39;</span><span class="p">:</span><span class="n">directives</span><span class="o">.</span><span class="n">positive_int</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="s">&#39;datafilecounter&#39;</span><span class="p">):</span>
            <span class="n">env</span><span class="o">.</span><span class="n">datafilecounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">env</span><span class="o">.</span><span class="n">datafilecounter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="s">&#39;cols&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span><span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">]))</span>
        <span class="k">if</span> <span class="s">&#39;rows&#39;</span><span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;divid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;filecontent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>

        <span class="k">if</span> <span class="s">&#39;hide&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;hide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;block&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;hide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span>

        <span class="k">if</span> <span class="s">&#39;edit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;edit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">DataFileNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)]</span>
</pre></div>
</div>
<p>As you can see our class has some shared/static/class level variables that specify whether the directive has content, how many arguments, and what the names and types of the arguments are.</p>
<p>Here are the possible types for the options:</p>
<ul class="simple">
<li>flag: For options with no option arguments. Checks for an argument (raises ValueError if found), returns None for valid flag options.</li>
<li>unchanged_required: Returns the text argument, unchanged. Raises ValueError if no argument is found.</li>
<li>unchanged: Returns the text argument, unchanged. Returns an empty string (&#8220;&#8221;) if no argument is found.</li>
<li>path: Returns the path argument unwrapped (with newlines removed). Raises ValueError if no argument is found.</li>
<li>uri: Returns the URI argument with whitespace removed. Raises ValueError if no argument is found.</li>
<li>nonnegative_int: Checks for a nonnegative integer argument, and raises ValueError if not.</li>
<li>class_option: Converts the argument into an ID-compatible string and returns it. Raises ValueError if no argument is found.</li>
<li>unicode_code: Convert a Unicode character code to a Unicode character.</li>
<li>single_char_or_unicode: A single character is returned as-is. Unicode characters codes are converted as in unicode_code.</li>
<li>single_char_or_whitespace_or_unicode: As with single_char_or_unicode, but &#8220;tab&#8221; and &#8220;space&#8221; are also supported.</li>
<li>positive_int: Converts the argument into an integer. Raises ValueError for negative, zero, or non-integer values.</li>
<li>positive_int_list: Converts a space- or comma-separated list of integers into a Python list of integers. Raises ValueError for non-positive-integer values.</li>
<li>encoding: Verfies the encoding argument by lookup. Raises ValueError for unknown encodings.</li>
</ul>
<p>There are two important instance variables to think about.</p>
<ul class="simple">
<li>self.content  Refers to the body content of the directive.  That is the indented text that comes after the options.  This can be anything, and you can make up your own conventions for how to interpret the body of a directive.</li>
<li>self.options  Is a dictionary that contins key value pairs for all of  the optional parameters.  Of course you are free to modify this dictionary as much as you wish.</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">self.options</span></tt> instance variable is a dictionary that will be used later to fill in a template for our output.  So, most of the processing in the <tt class="docutils literal"><span class="pre">run</span></tt> method is checking to see if the author provided values for these options and providing some default values for them if they have not.</p>
<p>The last line of <tt class="docutils literal"><span class="pre">run</span></tt> creates an instance of our DataFileNode.  This object doesn&#8217;t do much other than act as a container to hold our data until it is time to render the output.  Nevertheless here is the code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">DataFileNode</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">General</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments:</span>
<span class="sd">        - `self`:</span>
<span class="sd">        - `content`:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataFileNode</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_content</span> <span class="o">=</span> <span class="n">content</span>
</pre></div>
</div>
</div>
<div class="section" id="output">
<h2>Output<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h2>
<p>In the final stage of processing we render the document in whatever format the author is requesting.  In this stage we take the data stored away in our <tt class="docutils literal"><span class="pre">DataFileNode</span></tt> and turn it into html or latex or whatever.</p>
<p>Each output format is handled by their own function that is registered back in the setup phase.  recall that we used the following line to connect our html output with a couple of functions:  <tt class="docutils literal"><span class="pre">app.add_node(DataFileNode,</span> <span class="pre">html=(visit_df_node,</span> <span class="pre">depart_df_node))</span></tt>.</p>
<p>We will use Python triple quoted strings to create a couple of templates to fill in.  In the code below these templates are <tt class="docutils literal"><span class="pre">PRE</span></tt> and <tt class="docutils literal"><span class="pre">TEXTA</span></tt></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">PRE</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">&lt;pre id=&quot;</span><span class="si">%(divid)s</span><span class="s">&quot; style=&quot;display: </span><span class="si">%(hide)s</span><span class="s">;&quot;&gt;</span>
<span class="si">%(filecontent)s</span><span class="s"></span>
<span class="s">&lt;/pre&gt;</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="n">TEXTA</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">&lt;textarea id=&quot;</span><span class="si">%(divid)s</span><span class="s">&quot; rows=&quot;</span><span class="si">%(rows)d</span><span class="s">&quot; cols=&quot;</span><span class="si">%(cols)d</span><span class="s">&quot;&gt;</span>
<span class="si">%(filecontent)s</span><span class="s"></span>
<span class="s">&lt;/textarea&gt;</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="c"># self for these functions is an instance of the writer class.  For example</span>
<span class="c"># in html, self is sphinx.writers.html.SmartyPantsHTMLTranslator</span>
<span class="c"># The node that is passed as a parameter is an instance of our node class.</span>
<span class="k">def</span> <span class="nf">visit_df_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">df_content</span><span class="p">[</span><span class="s">&#39;edit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">TEXTA</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">PRE</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">df_content</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;u&#39;&quot;</span><span class="p">,</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>  <span class="c"># hack:  there must be a better way to include the list and avoid unicode strings</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">depart_ac_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This is called at the start of processing an activecode node.  If activecode had recursive nodes</span>
<span class="sd">        etc and did not want to do all of the processing in visit_ac_node any finishing touches could be</span>
<span class="sd">        added here.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">visit_df_node</span></tt> function is called when a DataFileNode is found in the document tree.  The visit function is called when the node is first encountered.  The <tt class="docutils literal"><span class="pre">depart_df_node</span></tt> function is called after all the children have been visited.</p>
<p>Notice that <tt class="docutils literal"><span class="pre">visit_df_node</span></tt> mainly just looks at its options to see if we need to create a textarea or a pre element and then lets Python&#8217;s formatted strings take care of the rest.</p>
</div>
</div>


</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <span id='numuserspan'></span> readers online now | <span class='loggedinuser'></span> | <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2013, Brad Miller.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.1.
    </p>
  </div>
</footer>

<script type="text/javascript" charset="utf-8">
    $(document).ready(addUserToFooter);
    $(document).ready(addNavbarLoginLink);
    $(document).ready(createEditors);
    $(document).ready(getNumUsers);
    $(document).ready(getOnlineUsers);
    $(document).ready(createScratchActivecode());
    $(document).ready(styleUnittestResults());
</script>

<script type="text/javascript">
  // add the video play button overlay image
  $(".video-play-overlay").each(function() {
    $(this).css('background-image', "url(\'_static/play_overlay_icon.png\')")
    });

  // This function is needed to allow the dropdown search bar to work;
  // The default behaviour is that the dropdown menu closes when something in
  // it (like the search bar) is clicked
  $(function() {
    // Fix input element click problem
    $('.dropdown input, .dropdown label').click(function(e) {
      e.stopPropagation();
      });
  });

  // style codelens buttons (doing it here because PyTutor is a submodule owned by someone else
  $(function() {
    $(".ExecutionVisualizer").each(function() {
      $(this).find("#jmpFirstInstr").addClass('btn btn-default');
      $(this).find("#jmpStepBack").addClass('btn btn-danger');
      $(this).find("#jmpStepFwd").addClass('btn btn-success');
      $(this).find("#jmpLastInstr").addClass('btn btn-default');
      });
  });

</script>


<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-32029811-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



  </body>
</html>